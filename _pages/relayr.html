---
layout: page
title: Query
permalink: /relayr/
---
<link rel="stylesheet" href="/assets/css/relayr.css">

<div class="relayr-container">
  <div class="relayr-header">
    <h1>Query a Relay</h1>
    <div id="connectionState" class="state">Loading ...</div>
  </div>

  <div class="card">
    <div class="controls">
      <div>
        <label for="relaySelect">Pick a relay</label>
        <select name="relaySelect" id="relaySelect" class="select">
          {% for r in site.data.relays.wss %}
            <option value="wss://{{ r }}">{{ r }}</option>
          {% endfor %}
        </select>
        <div style="margin-top:0.5rem;">or bring your own:</div>
        <input id="relay" class="text-input" placeholder="wss://relay.example.org" />
      </div>

      <div>
        <label for="querySelect">Presets</label>
        <select id="querySelect" class="select" onchange="input.value=querySelect.value">
          <option value='["REQ","cn",
    {"limit":2,"kinds":[0]},
    {"limit":2,"kinds":[1]},
    {"limit":2,"kinds":[2]}]'>queries</option>
          <option value='["REQ","cn",{"authors":["46fcbe3065eaf1ae7811465924e48923363ff3f526bd6f73d7c184b16bd8ce4d"],"kinds":[4],"limit":1000} ]'>All kind 4 events from pubkey</option>
          <option value='["REQ","cn",{"#p":["46fcbe3065eaf1ae7811465924e48923363ff3f526bd6f73d7c184b16bd8ce4d"],"kinds":[4],"limit":1000} ]'>All kind 4 events to pubkey</option>
        </select>

        <div style="margin-top:0.75rem;">
          <label for="input">Query / Event</label>
          <textarea id="input" class="textarea" placeholder="Queries or events" style="min-height: 6em;"></textarea>
        </div>

        <div class="toolbar" style="margin-top:0.75rem;">
          <button type="button" id="send" class="btn" onClick="sendInput()">Send</button>
          <button type="button" id="clearOutput" class="btn secondary" onclick="(function(){window.received=[]; if (outputBox) outputBox.textContent='';})()">Clear</button>
        </div>
      </div>
    </div>

    <div style="margin-top:1rem;" class="grid-2">
      <div>
        <div style="font-weight:600;margin-bottom:0.5rem;">Responses</div>
        <div id="outputBox" class="output-box" aria-live="polite"></div>
      </div>
      <div>
        <div style="font-weight:600;margin-bottom:0.5rem;">Quick Info</div>
        <div class="card" style="padding:0.75rem;">
          <div><strong>Connection:</strong> <span id="connSummary">—</span></div>
          <div style="margin-top:0.5rem;"><strong>Last RID:</strong> <span id="lastRid">—</span></div>
          <div style="margin-top:0.5rem;color:#666;font-size:0.9rem;">Note: connecting to relays exposes your client IP to the relay.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const querySelect = document.getElementById("querySelect")
const relaySelect = document.getElementById("relaySelect")
const relay = document.getElementById("relay")
const input = document.getElementById("input")
const outputBox = document.getElementById("outputBox")
const connectionState = document.getElementById("connectionState")
const connSummary = document.getElementById("connSummary")
const lastRid = document.getElementById("lastRid")
var ws

window.received = []
window.onload = () => {
  input.value=querySelect.value
  relay.value = relaySelect.value
  setupWebSocket()
}
relaySelect.onchange = () => {
  relay.value = relaySelect.value
  setupWebSocket()
}
relay.onchange = setupWebSocket

function sendInput() {
  // clear displayed responses and buffer
  if (outputBox) outputBox.textContent = ''
  window.received = []
  // ensure websocket is open
  if (!ws || ws.readyState !== WebSocket.OPEN) {
    connectionState.className = 'state error'
    connectionState.innerText = 'Socket not open. Connect first.'
    return
  }
  try {
    ws.send(input.value)
  } catch (e) {
    connectionState.className = 'state error'
    connectionState.innerText = `Send error: ${e}`
  }
}

function setupWebSocket() {
  if (ws) {
    ws.onclose = () => {}
    ws.close()
  }
  getNip11()
  connectionState.className = 'state connecting'
  connectionState.innerText = `Connecting to ${relay.value}`
  connSummary.innerText = 'Connecting'
  ws = new WebSocket(relay.value);
  ws.onmessage = msg => {
    if (msg.data.startsWith('["RID",')) {
      const rid = JSON.parse(msg.data)[1]
      console.log(rid)
      lastRid.innerText = rid
    } else {
      window.received.push(msg.data)
      if (window.received.length > 1000) window.received.shift()
    }
  }
  ws.onclose = () => {
    connectionState.className = 'state error'
    connectionState.innerText = 'Disconnected'
    connSummary.innerText = 'Disconnected'
  }
  ws.onopen = () => {
    connectionState.className = 'state connected'
    connectionState.innerText = `Connected to ${ws.url}`
    connSummary.innerText = ws.url
    ws.send('["RID"]')
    sendInput()
  }
  ws.onerror = (e) => {
    connectionState.className = 'state error'
    connectionState.innerText = `Error (${ws.url}): ${e}`
    connSummary.innerText = 'Error'
  }
}

function getNip11() {
  const url = 'https' + relay.value.slice(3)
  const options = {
    method: 'get',
    headers: {
      Accept: 'application/nostr+json'
    }
  }
  fetch(url, options)
    .then(console.log)
}

setInterval(() => {
  const l = window.received.length
  let msgs = ""
  for (let i = Math.min(10, l); i > 0; i--) {
    msgs += window.received[l - i] + "\n"
  }
  const status = `Received ${l} events. Last ones received (probably oldest):\n${msgs}`
  if (outputBox) outputBox.textContent = status
}, 500)
</script>
<!-- styling moved to assets/css/relayr.css -->
